<!DOCTYPE html>
<html>
<head>
    <title>Estate V71 - Fixed Engine</title>
    <style>
        body { margin: 0; overflow: hidden; background: #111; font-family: sans-serif; }
        #overlay { position: absolute; width: 100%; height: 100%; background: #000; color: #FFD700; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        #ui { position: absolute; top: 10px; left: 10px; color: #fff; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px; border-left: 5px solid #FFD700; pointer-events: none; }
        #radioBox { position: absolute; bottom: 20px; right: 20px; background: #222; padding: 15px; border-radius: 10px; border: 2px solid #FFD700; color: #fff; pointer-events: auto; }
        #tipBox { position: absolute; top: 10px; right: 10px; pointer-events: auto; }
        .btn { padding: 15px 30px; background: #FFD700; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; font-size: 18px; }
        #msg { position: absolute; top: 30%; width: 100%; text-align: center; color: #FFD700; font-size: 32px; font-weight: bold; opacity: 0; transition: 0.5s; pointer-events: none; }
    </style>
</head>
<body>

    <div id="overlay">
        <h1>ESTATE V71</h1>
        <p>3D Engine Ready</p>
        <button class="btn" onclick="startEngine()">START ENGINE & SOUND</button>
    </div>

    <div id="ui">
        <b>W / S</b>: Move | <b>A / D</b>: Turn<br>
        <b>E</b>: Drive/Exit | <b>SPACE</b>: Jump<br>
        <hr>
        Car Status: <span id="carStatus" style="color:#ff4444">Standard</span>
    </div>

    <div id="tipBox">
        <button class="btn" style="padding: 10px;" onclick="processTip()">ðŸ’° TIP $100 FOR GOLD</button>
    </div>

    <div id="radioBox">
        ðŸ“» <b>RADIO CHANNELS</b><br>
        <button onclick="playStation(1)">1: Faith</button>
        <button onclick="playStation(2)">2: Gaming</button>
        <button onclick="playStation(3)">3: Rock/Rap</button>
        <button onclick="playStation(0)">OFF</button>
    </div>

    <div id="msg">BULLION GOLD ACTIVATED</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, car, carBody, audioCtx, osc, gain;
        let keyStack = [], playerYaw = 0, isDriving = false;

        function startEngine() {
            document.getElementById('overlay').style.display = 'none';
            init();
            // Create audio context on user click to bypass browser blocks
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, 20);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Sunlight for Shine
            const sun = new THREE.DirectionalLight(0xffffff, 1.5);
            sun.position.set(10, 20, 10);
            scene.add(sun);
            scene.add(new THREE.AmbientLight(0xffffff, 0.4));

            // Grass Floor
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(1000, 1000), 
                new THREE.MeshStandardMaterial({color: 0x1b5e20, roughness: 0.8})
            );
            floor.rotation.x = -Math.PI/2;
            scene.add(floor);

            // Village Houses
            for(let i=0; i<5; i++) {
                const house = new THREE.Mesh(new THREE.BoxGeometry(10, 10, 10), new THREE.MeshStandardMaterial({color: 0x555555}));
                house.position.set(-30, 5, i * -25);
                scene.add(house);
            }

            // Create Car
            car = new THREE.Group();
            carBody = new THREE.Mesh(
                new THREE.BoxGeometry(4, 2, 7), 
                new THREE.MeshStandardMaterial({color: 0xaa0000, metalness: 0.2, roughness: 0.5})
            );
            carBody.position.y = 1;
            car.add(carBody);
            scene.add(car);

            window.addEventListener('keydown', e => { if(!keyStack.includes(e.code)) keyStack.push(e.code); if(e.code==='KeyE') isDriving=!isDriving; });
            window.addEventListener('keyup', e => keyStack = keyStack.filter(k => k !== e.code));

            animate();
        }

        function processTip() {
            let tip = prompt("Enter tip amount ($):");
            if (parseInt(tip) >= 100) {
                carBody.material.color.setHex(0xFFD700);
                carBody.material.metalness = 1.0; 
                carBody.material.roughness = 0.05;
                carBody.material.emissive.setHex(0x332200);
                document.getElementById('carStatus').innerText = "24K GOLD";
                document.getElementById('carStatus').style.color = "#FFD700";
                document.getElementById('msg').style.opacity = 1;
                setTimeout(() => document.getElementById('msg').style.opacity = 0, 3000);
            }
        }

        function playStation(ch) {
            if (osc) osc.stop();
            if (ch === 0) return;

            osc = audioCtx.createOscillator();
            gain = audioCtx.createGain();
            
            if (ch === 1) { osc.type = 'sine'; osc.frequency.value = 440; } // Faith
            if (ch === 2) { osc.type = 'square'; osc.frequency.value = 220; } // Gaming
            if (ch === 3) { osc.type = 'sawtooth'; osc.frequency.value = 110; } // Rock/Rap

            gain.gain.value = 0.05;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
        }

        function animate() {
            requestAnimationFrame(animate);
            const topKey = keyStack[keyStack.length - 1];
            const dir = new THREE.Vector3();
            camera.getWorldDirection(dir); dir.y = 0; dir.normalize();

            if (topKey === 'KeyW') {
                if(isDriving) car.position.add(dir.clone().multiplyScalar(0.8));
                else camera.position.add(dir.clone().multiplyScalar(0.5));
            }
            if (topKey === 'KeyS') {
                if(isDriving) car.position.sub(dir.clone().multiplyScalar(0.8));
                else camera.position.sub(dir.clone().multiplyScalar(0.5));
            }
            if (topKey === 'KeyA') playerYaw += 0.03;
            if (topKey === 'KeyD') playerYaw -= 0.03;

            if(isDriving) {
                car.rotation.y = playerYaw - Math.PI;
                camera.position.set(car.position.x - Math.sin(playerYaw)*15, 8, car.position.z - Math.cos(playerYaw)*15);
                camera.lookAt(car.position);
            } else {
                camera.rotation.y = playerYaw;
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
