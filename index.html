<!DOCTYPE html>
<html>
<head>
    <title>3D Cave - Small Room</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        #ui { 
            position: absolute; top: 10px; left: 10px; 
            color: #00ff00; font-family: monospace; pointer-events: none; 
            background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid #0f0;
        }
    </style>
</head>
<body>
    <div id="ui">
        <h1>CAVE_SMALL_TEST</h1>
        <p>WASD to Move | Arrows to Turn</p>
        <p id="dist">DISTANCE: SCANNING...</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        const scene = new THREE.Scene();
        scene.fog = new THREE.Fog(0x000000, 1, 15);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const caveMat = new THREE.MeshStandardMaterial({ color: 0x222222 });

        // 1. THE SHORT CAVE (Box Layout)
        // Floor & Ceiling
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(10, 20), caveMat);
        floor.rotation.x = -Math.PI/2; floor.position.y = -1; scene.add(floor);

        const ceil = new THREE.Mesh(new THREE.PlaneGeometry(10, 20), caveMat);
        ceil.rotation.x = Math.PI/2; ceil.position.y = 2; scene.add(ceil);

        // Side Walls
        const sideWallGeo = new THREE.PlaneGeometry(20, 3);
        const leftWall = new THREE.Mesh(sideWallGeo, caveMat);
        leftWall.rotation.y = Math.PI/2; leftWall.position.x = -5; scene.add(leftWall);

        const rightWall = new THREE.Mesh(sideWallGeo, caveMat);
        rightWall.rotation.y = -Math.PI/2; rightWall.position.x = 5; scene.add(rightWall);

        // THE BACK WALL (The one that was missing)
        const backWall = new THREE.Mesh(new THREE.PlaneGeometry(10, 3), caveMat);
        backWall.position.z = -10; scene.add(backWall);

        // 2. THE TREASURE
        const treasure = new THREE.Mesh(
            new THREE.BoxGeometry(0.5, 0.5, 0.5),
            new THREE.MeshStandardMaterial({ color: 0xFFD700, emissive: 0xffaa00 })
        );
        treasure.position.set(0, 0, -5);
        scene.add(treasure);

        // 3. LIGHTS
        const light = new THREE.PointLight(0xffffff, 2, 10);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x333333));

        // 4. CONTROL LOGIC
        let keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        let rot = 0;
        camera.position.z = 5;

        function animate() {
            requestAnimationFrame(animate);

            // Turning
            if (keys['ArrowLeft']) rot += 0.04;
            if (keys['ArrowRight']) rot -= 0.04;
            camera.rotation.y = rot;

            // Movement
            const spd = 0.1;
            if (keys['KeyW']) {
                camera.position.x -= Math.sin(rot) * spd;
                camera.position.z -= Math.cos(rot) * spd;
            }
            if (keys['KeyS']) {
                camera.position.x += Math.sin(rot) * spd;
                camera.position.z += Math.cos(rot) * spd;
            }

            // STAY INSIDE THE BOX (Collision)
            if (camera.position.x > 4.5) camera.position.x = 4.5;
            if (camera.position.x < -4.5) camera.position.x = -4.5;
            if (camera.position.z > 9) camera.position.z = 9;
            if (camera.position.z < -9) camera.position.z = -9;

            light.position.copy(camera.position);
            treasure.rotation.y += 0.02;

            const d = camera.position.distanceTo(treasure.position);
            document.getElementById('dist').innerText = "DIST: " + d.toFixed(1) + "m";

            if(d < 0.8) {
                alert("FOUND IT!");
                treasure.position.set(Math.random()*6-3, 0, Math.random()*-8);
            }

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
