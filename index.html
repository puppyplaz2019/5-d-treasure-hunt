<!DOCTYPE html>
<html>
<head>
    <title>3D Cave - Grounded Fix</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        #ui { 
            position: absolute; top: 10px; left: 10px; 
            color: #00ff00; font-family: monospace; pointer-events: none; 
            background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid #0f0;
        }
    </style>
</head>
<body>
    <div id="ui">
        <h1>CAVE_EXPLORER_V7</h1>
        <p>WASD: Walk | Arrows: Look</p>
        <p id="dist">DISTANCE: ---</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        const scene = new THREE.Scene();
        scene.fog = new THREE.Fog(0x000000, 1, 18);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const rockMat = new THREE.MeshStandardMaterial({ color: 0x222222 });

        // THE CAVE
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(20, 40), rockMat);
        floor.rotation.x = -Math.PI/2; floor.position.y = -1.5; scene.add(floor);

        const ceil = new THREE.Mesh(new THREE.PlaneGeometry(20, 40), rockMat);
        ceil.rotation.x = Math.PI/2; ceil.position.y = 5; scene.add(ceil);

        // Side Walls (Moved further out so you don't get stuck)
        const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(40, 10), rockMat);
        leftWall.rotation.y = Math.PI/2; leftWall.position.x = -9; scene.add(leftWall);

        const rightWall = new THREE.Mesh(new THREE.PlaneGeometry(40, 10), rockMat);
        rightWall.rotation.y = -Math.PI/2; rightWall.position.x = 9; scene.add(rightWall);

        const backWall = new THREE.Mesh(new THREE.PlaneGeometry(20, 10), rockMat);
        backWall.position.z = -18; scene.add(backWall);

        // STALACTITES
        for(let i=0; i<30; i++) {
            const h = Math.random() * 3 + 1;
            const spike = new THREE.Mesh(new THREE.ConeGeometry(0.3, h, 6), rockMat);
            spike.position.set(Math.random()*16-8, 5-(h/2), Math.random()*36-18);
            spike.rotation.x = Math.PI;
            scene.add(spike);
        }

        // TREASURE CHEST (Made slightly bigger to see better)
        const chest = new THREE.Group();
        const b = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.6, 0.7), new THREE.MeshStandardMaterial({color: 0x4A3728}));
        const l = new THREE.Mesh(new THREE.BoxGeometry(1.25, 0.3, 0.75), new THREE.MeshStandardMaterial({color: 0xD4AF37}));
        l.position.y = 0.4;
        chest.add(b); chest.add(l);
        chest.position.set(0, -1.2, -10);
        scene.add(chest);

        // LIGHTS
        const flashlight = new THREE.PointLight(0xffffff, 2.5, 20);
        scene.add(flashlight);
        scene.add(new THREE.AmbientLight(0x222222));

        // CONTROLS
        let keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        let yaw = 0;   // Left/Right
        let pitch = 0; // Up/Down
        camera.position.set(0, 0, 10); // Start at ground level

        function animate() {
            requestAnimationFrame(animate);

            // 1. LOOKING (Arrows) - No movement attached
            if (keys['ArrowLeft']) yaw += 0.05;
            if (keys['ArrowRight']) yaw -= 0.05;
            if (keys['ArrowUp']) pitch += 0.04;
            if (keys['ArrowDown']) pitch -= 0.04;

            pitch = Math.max(-1.2, Math.min(1.2, pitch));
            camera.rotation.set(pitch, yaw, 0, 'YXZ');

            // 2. WALKING (WASD) - Relative to rotation
            const spd = 0.15;
            if (keys['KeyW']) {
                camera.position.x -= Math.sin(yaw) * spd;
                camera.position.z -= Math.cos(yaw) * spd;
            }
            if (keys['KeyS']) {
                camera.position.x += Math.sin(yaw) * spd;
                camera.position.z += Math.cos(yaw) * spd;
            }
            if (keys['KeyA']) {
                camera.position.x -= Math.cos(yaw) * spd;
                camera.position.z += Math.sin(yaw) * spd;
            }
            if (keys['KeyD']) {
                camera.position.x += Math.cos(yaw) * spd;
                camera.position.z -= Math.cos(yaw) * spd;
            }

            // 3. COLLISION (Stay inside walls)
            if (camera.position.x > 8.5) camera.position.x = 8.5;
            if (camera.position.x < -8.5) camera.position.x = -8.5;
            if (camera.position.z > 18) camera.position.z = 18;
            if (camera.position.z < -18) camera.position.z = -18;

            flashlight.position.copy(camera.position);

            const d = camera.position.distanceTo(chest.position);
            document.getElementById('dist').innerText = "DISTANCE: " + d.toFixed(1) + "m";

            // If you get within 1.5 meters, you get the treasure
            if(d < 1.5) {
                alert("âœ¨ TREASURE CLAIMED!");
                chest.position.set(Math.random()*14-7, -1.2, Math.random()*-30+10);
            }

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
