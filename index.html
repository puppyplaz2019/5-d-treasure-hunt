<!DOCTYPE html>
<html>
<head>
    <title>3D Cave - Stalactite Update</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        #ui { 
            position: absolute; top: 10px; left: 10px; 
            color: #00ff00; font-family: monospace; pointer-events: none; 
            background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid #0f0;
        }
    </style>
</head>
<body>
    <div id="ui">
        <h1>CAVE_EXPLORER_V4</h1>
        <p>LOOK UP! High ceiling with Stalactites</p>
        <p id="dist">DISTANCE TO CHEST: SCANNING...</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        const scene = new THREE.Scene();
        scene.fog = new THREE.Fog(0x000000, 1, 18);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const rockMat = new THREE.MeshStandardMaterial({ color: 0x333333 });

        // 1. THE TALL CAVE
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(12, 24), rockMat);
        floor.rotation.x = -Math.PI/2; floor.position.y = -1; scene.add(floor);

        const ceil = new THREE.Mesh(new THREE.PlaneGeometry(12, 24), rockMat);
        ceil.rotation.x = Math.PI/2; ceil.position.y = 5; scene.add(ceil); // TALLER

        const sideWallGeo = new THREE.PlaneGeometry(24, 6); // TALLER WALLS
        const leftWall = new THREE.Mesh(sideWallGeo, rockMat);
        leftWall.rotation.y = Math.PI/2; leftWall.position.x = -6; leftWall.position.y = 2; scene.add(leftWall);

        const rightWall = new THREE.Mesh(sideWallGeo, rockMat);
        rightWall.rotation.y = -Math.PI/2; rightWall.position.x = 6; rightWall.position.y = 2; scene.add(rightWall);

        const backWall = new THREE.Mesh(new THREE.PlaneGeometry(12, 6), rockMat);
        backWall.position.z = -12; backWall.position.y = 2; scene.add(backWall);

        // 2. ADD STALACTITES (Spikes from roof)
        for(let i=0; i<15; i++) {
            const spikeGeo = new THREE.ConeGeometry(0.3, 2, 4);
            const spike = new THREE.Mesh(spikeGeo, rockMat);
            spike.position.set(Math.random()*10-5, 4, Math.random()*-20+10);
            spike.rotation.x = Math.PI; // Point them down
            scene.add(spike);
        }

        // 3. THE TREASURE CHEST
        const chestGroup = new THREE.Group();
        
        // Chest Base (Wood)
        const base = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.4, 0.5), new THREE.MeshStandardMaterial({color: 0x5C4033}));
        chestGroup.add(base);

        // Chest Lid (Gold)
        const lid = new THREE.Mesh(new THREE.BoxGeometry(0.82, 0.2, 0.52), new THREE.MeshStandardMaterial({color: 0xFFD700}));
        lid.position.y = 0.3;
        chestGroup.add(lid);

        chestGroup.position.set(0, -0.8, -8);
        scene.add(chestGroup);

        // 4. LIGHTS
        const light = new THREE.PointLight(0xffffff, 2, 15);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x222222));

        // 5. CONTROLS
        let keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        let rot = 0;
        camera.position.z = 8;
        camera.position.y = 0.5;

        function animate() {
            requestAnimationFrame(animate);
            if (keys['ArrowLeft']) rot += 0.04;
            if (keys['ArrowRight']) rot -= 0.04;
            camera.rotation.y = rot;

            const spd = 0.12;
            if (keys['KeyW']) {
                camera.position.x -= Math.sin(rot) * spd;
                camera.position.z -= Math.cos(rot) * spd;
            }
            if (keys['KeyS']) {
                camera.position.x += Math.sin(rot) * spd;
                camera.position.z += Math.cos(rot) * spd;
            }

            // COLLISION
            if (camera.position.x > 5.5) camera.position.x = 5.5;
            if (camera.position.x < -5.5) camera.position.x = -5.5;
            if (camera.position.z > 11) camera.position.z = 11;
            if (camera.position.z < -11) camera.position.z = -11;

            light.position.copy(camera.position);
            
            const d = camera.position.distanceTo(chestGroup.position);
            document.getElementById('dist').innerText = "DIST TO CHEST: " + d.toFixed(1) + "m";

            if(d < 1.0) {
                alert("ðŸ’° TREASURE CHEST OPENED!");
                chestGroup.position.set(Math.random()*8-4, -0.8, Math.random()*-15);
            }

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
